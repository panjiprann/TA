<!DOCTYPE html>
<html lang="id" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndoRates Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --bg-main: #0f172a; --bg-card: #1e293b; --accent: #38bdf8; }
        body { background-color: var(--bg-main); font-family: 'Inter', sans-serif; color: #e2e8f0; }
        .card { background-color: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; }
        .btn-primary { background: var(--accent); border: none; color: #000; font-weight: bold; }
        .btn-primary:hover { background: #0ea5e9; }
        .hidden { display: none !important; }
        
        /* 1. Scrollbar Halus (Global) */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* 2. Scroll untuk List Kurs */
        .scrollable-list { max-height: 400px; overflow-y: auto; }

        /* 3. Scroll & Sticky Header untuk Tabel Admin */
        .admin-table-scroll {
            max-height: 300px; /* Tinggi maksimal tabel */
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
        }
        /* Sticky Header Logic */
        .admin-table-scroll thead th {
            position: sticky;
            top: 0;
            background-color: #1e293b; /* Samakan dengan warna card */
            z-index: 5;
            box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4); /* Bayangan pemisah */
        }
    </style>
</head>
<body>

    <nav class="navbar border-bottom border-secondary mb-4 p-3" style="background: rgba(15, 23, 42, 0.9);">
        <div class="container d-flex justify-content-between">
            <h5 class="m-0 fw-bold text-white">IndoRates <span class="text-info">PRO</span></h5>
            <button id="btn-logout" onclick="logout()" class="btn btn-sm btn-outline-danger hidden">Keluar</button>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div id="auth-section" class="row justify-content-center" style="min-height: 60vh; align-items: center;">
            <div class="col-md-5">
                <div class="card p-4 shadow-lg">
                    <h4 class="text-center mb-4" id="auth-title">Login Member</h4>
                    <div id="form-login">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Username</label>
                            <input type="text" id="login-user" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Password</label>
                            <input type="password" id="login-pass" class="form-control">
                        </div>
                        <button onclick="doLogin()" class="btn btn-primary w-100 mb-3">Masuk</button>
                        <p class="text-center small">Belum punya akun? <a href="#" onclick="toggleAuth()" class="text-info text-decoration-none">Daftar sekarang</a></p>
                    </div>
                    <div id="form-register" class="hidden">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Username Baru</label>
                            <input type="text" id="reg-user" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Password Baru</label>
                            <input type="password" id="reg-pass" class="form-control">
                        </div>
                        <button onclick="doRegister()" class="btn btn-success w-100 mb-3">Daftar Akun</button>
                        <p class="text-center small">Sudah punya akun? <a href="#" onclick="toggleAuth()" class="text-info text-decoration-none">Login</a></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard-section" class="hidden">
            <div class="alert alert-dark border border-secondary d-flex justify-content-between align-items-center mb-4">
                <span>Selamat datang, <b id="display-username" class="text-white">User</b></span>
                <span class="small text-muted">API Key: <code id="display-key" class="text-warning">...</code></span>
            </div>

            <div id="admin-panel" class="card p-4 mb-4 border-warning hidden">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-warning m-0 fw-bold">ADMIN DATA CONTROL</h6>
                    <button onclick="loadAllUsers()" class="btn btn-sm btn-outline-warning">Refresh Data</button>
                </div>
                <div id="admin-result" class="small text-muted">Memuat data...</div>
            </div>

            <div class="row g-4">
                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="m-0">Daftar Kurs Live</h5>
                            <button onclick="getRates()" class="btn btn-sm btn-outline-secondary">Refresh</button>
                        </div>
                        <div class="scrollable-list">
                            <ul id="ratesList" class="list-group list-group-flush small">Loading...</ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card p-4 h-100">
                        <h5 class="mb-1">Kalkulator Konversi</h5>
                        <p class="text-muted small mb-4">Hitung nilai tukar ke Rupiah (IDR)</p>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Pilih Mata Uang</label>
                            <select id="currencySelect" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small text-muted">Nominal</label>
                            <input type="number" id="amountInput" class="form-control" placeholder="0">
                        </div>
                        <button onclick="convertCurrency()" class="btn btn-primary w-100">Hitung</button>
                        <div class="mt-4 text-center">
                            <small class="text-muted">Hasil Konversi</small>
                            <div id="resultBox" class="fs-3 fw-bold text-info">Rp 0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let MY_TOKEN = localStorage.getItem('indorates_token') || ''; 

        // --- AUTH ---
        function toggleAuth() {
            document.getElementById('form-login').classList.toggle('hidden');
            document.getElementById('form-register').classList.toggle('hidden');
            const title = document.getElementById('auth-title');
            title.innerText = title.innerText === 'Login Member' ? 'Daftar Akun' : 'Login Member';
        }

        async function doRegister() {
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;
            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });
                const data = await res.json();
                if(data.status === 'success') {
                    alert("Registrasi Berhasil. Silakan Login.");
                    toggleAuth(); 
                } else { alert("Gagal: " + data.error); }
            } catch (err) { alert("Error koneksi server"); }
        }

        async function doLogin() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: user, password: pass })
                });
                const data = await res.json();
                if(data.status === 'success') {
                    MY_TOKEN = data.api_key;
                    localStorage.setItem('indorates_token', MY_TOKEN);
                    setupDashboard(data);
                } else { alert("Login Gagal: " + data.error); }
            } catch (err) { alert("Error koneksi server"); }
        }

        function logout() {
            localStorage.removeItem('indorates_token');
            location.reload(); 
        }

        function setupDashboard(userData) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('btn-logout').classList.remove('hidden');
            document.getElementById('display-username').innerText = userData.username;
            document.getElementById('display-key').innerText = userData.api_key;

            if(userData.role === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
                loadAllUsers();
            }
            getRates();
        }

        // --- FEATURES ---
        async function getRates() {
            const list = document.getElementById('ratesList');
            const select = document.getElementById('currencySelect');
            list.innerHTML = '<span class="text-muted">Mengambil data...</span>';
            try {
                const res = await fetch('/api/rates', { headers: { 'x-api-key': MY_TOKEN } });
                const json = await res.json();
                if(res.status !== 200) throw new Error(json.error);

                list.innerHTML = '';
                select.innerHTML = ''; 
                for (const [code, rate] of Object.entries(json.data.rates)) {
                    // List Item
                    list.innerHTML += `<li class="list-group-item bg-transparent text-white d-flex justify-content-between border-secondary py-3">
                        <span class="fw-bold">${code}</span> 
                        <span>Rp ${rate.toLocaleString('id-ID')}</span>
                    </li>`;
                    // Dropdown Option
                    let option = document.createElement("option");
                    option.value = code;
                    option.text = `${code} - Rp ${rate.toLocaleString('id-ID')}`;
                    select.appendChild(option);
                }
            } catch (e) { list.innerHTML = `<span class="text-danger">Gagal: ${e.message}</span>`; }
        }

        async function convertCurrency() {
            const currency = document.getElementById('currencySelect').value;
            const amount = document.getElementById('amountInput').value;
            const res = await fetch('/api/convert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': MY_TOKEN },
                body: JSON.stringify({ currency, amount })
            });
            const json = await res.json();
            if(json.result) { document.getElementById('resultBox').innerText = "Rp " + json.result.toLocaleString('id-ID'); }
            else { alert("Error: " + json.error); }
        }

        // --- ADMIN CRUD (Scrollable + Sticky Header) ---
        async function loadAllUsers() {
            const res = await fetch('/api/admin/users', { headers: { 'x-api-key': MY_TOKEN } });
            const json = await res.json();
            
            // Perhatikan div wrapper 'admin-table-scroll'
            let html = `
            <div class="admin-table-scroll">
                <table class="table table-dark table-hover table-bordered m-0 align-middle">
                    <thead>
                        <tr class="text-secondary small text-uppercase">
                            <th style="width: 50px;">ID</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>API Key</th>
                            <th class="text-center" style="width: 140px;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            json.users.forEach(u => {
                html += `
                <tr>
                    <td class="text-center text-muted">${u.id}</td>
                    <td class="fw-bold text-white">${u.username}</td>
                    <td><span class="badge ${u.role === 'admin' ? 'bg-warning text-dark' : 'bg-secondary'}">${u.role}</span></td>
                    <td><code class="text-info small">${u.api_key.substring(0, 8)}...</code></td>
                    <td class="text-center">
                        <button onclick="regenerateKey(${u.id})" class="btn btn-sm btn-outline-info me-1" title="Reset Key (PUT)">üîÑ</button>
                        <button onclick="deleteUser(${u.id})" class="btn btn-sm btn-outline-danger" title="Hapus User">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
            html += `</tbody></table></div>`;
            document.getElementById('admin-result').innerHTML = html;
        }

        async function deleteUser(id) {
            if(!confirm("Yakin ingin menghapus user ini selamanya?")) return;
            const res = await fetch(`/api/admin/users/${id}`, { method: 'DELETE', headers: { 'x-api-key': MY_TOKEN } });
            const data = await res.json();
            if(data.status === 'success') { loadAllUsers(); } else { alert(data.error); }
        }

        async function regenerateKey(id) {
            if(!confirm("Update API Key user ini? (Method PUT)")) return;
            const res = await fetch(`/api/admin/users/${id}/reset-key`, { method: 'PUT', headers: { 'x-api-key': MY_TOKEN } });
            const data = await res.json();
            if(data.status === 'success') { alert("Key Baru: " + data.new_key); loadAllUsers(); } else { alert(data.error); }
        }
    </script>
</body>
</html>